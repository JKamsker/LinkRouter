<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:fa="using:FluentAvalonia.UI.Controls"
             xmlns:conv="clr-namespace:LinkRouter.Settings.Avalonia.Converters"
             x:Class="LinkRouter.Settings.Avalonia.Views.RulesWorkspacePage">
    <UserControl.Resources>
        <conv:StringHasValueConverter x:Key="StringHasValueConverter" />
    </UserControl.Resources>

    <ScrollViewer>
        <Grid Margin="32"
              RowDefinitions="Auto,*"
              ColumnDefinitions="2*,3*"
              ColumnSpacing="24"
              RowSpacing="24">
            <TextBlock Grid.ColumnSpan="2"
                       Style="{StaticResource SettingsPageTitleStyle}"
                       Text="Rules" />

            <Border Grid.Row="1"
                    Classes="SettingsCard">
                <Grid RowDefinitions="Auto,*" RowSpacing="16">
                    <fa:CommandBar DefaultLabelPosition="Right"
                                   Background="Transparent">
                        <fa:CommandBar.PrimaryCommands>
                            <fa:CommandBarButton Content="Add"
                                                 Command="{Binding AddRuleCommand}" />
                            <fa:CommandBarButton Content="Duplicate"
                                                 Command="{Binding DuplicateRuleCommand}"
                                                 CommandParameter="{Binding SelectedRule}" />
                            <fa:CommandBarButton Content="Delete"
                                                 Command="{Binding DeleteRuleCommand}"
                                                 CommandParameter="{Binding SelectedRule}" />
                            <fa:CommandBarButton Content="Move Up"
                                                 Command="{Binding MoveUpCommand}"
                                                 CommandParameter="{Binding SelectedRule}" />
                            <fa:CommandBarButton Content="Move Down"
                                                 Command="{Binding MoveDownCommand}"
                                                 CommandParameter="{Binding SelectedRule}" />
                        </fa:CommandBar.PrimaryCommands>
                    </fa:CommandBar>

                    <ListBox Grid.Row="1"
                             ItemsSource="{Binding Rules}"
                             SelectedItem="{Binding SelectedRule, Mode=TwoWay}"
                             Margin="0">
                        <ListBox.ItemTemplate>
                            <DataTemplate>
                                <StackPanel Orientation="Horizontal" Spacing="8">
                                    <TextBlock Text="{Binding DisplayName}" />
                                    <TextBlock Text="Enabled"
                                               Classes="RuleStatusLabel"
                                               IsVisible="{Binding Enabled}" />
                                </StackPanel>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>
                </Grid>
            </Border>

            <Border Grid.Row="1"
                    Grid.Column="1"
                    Classes="SettingsCard">
                <ScrollViewer>
                    <StackPanel Spacing="16">
                        <StackPanel Spacing="4">
                            <TextBlock Text="Selected Rule"
                                       Style="{StaticResource SettingsSectionTitleStyle}" />
                            <TextBlock TextWrapping="Wrap"
                                       Classes="SettingsBodyText"
                                       Text="{Binding SelectedRule.DisplayName, FallbackValue=Select a rule to view details., TargetNullValue=Select a rule to view details.}" />
                        </StackPanel>

                        <ToggleSwitch Content="Enabled"
                                      IsChecked="{Binding SelectedRule.Enabled, Mode=TwoWay}"
                                      IsEnabled="{Binding HasSelectedRule}" />

                        <StackPanel Spacing="8">
                            <TextBlock Text="Match"
                                       Style="{StaticResource SettingsBodyLabelStyle}" />
                            <StackPanel Orientation="Horizontal" Spacing="8">
                                <ComboBox ItemsSource="{Binding MatchTypes}"
                                          SelectedItem="{Binding SelectedRule.Match, Mode=TwoWay}"
                                          Width="160"
                                          IsEnabled="{Binding HasSelectedRule}" />
                                <TextBox Text="{Binding SelectedRule.Pattern, Mode=TwoWay}"
                                         Width="260"
                                         Watermark="Pattern"
                                         IsEnabled="{Binding HasSelectedRule}" />
                            </StackPanel>
                        </StackPanel>

                        <StackPanel Spacing="8">
                            <TextBlock Text="Use Profile"
                                       Style="{StaticResource SettingsBodyLabelStyle}" />
                            <StackPanel Orientation="Horizontal" Spacing="8">
                                <ComboBox ItemsSource="{Binding ProfileOptions}"
                                          SelectedItem="{Binding SelectedRule.UseProfile, Mode=TwoWay}"
                                          Width="220"
                                          PlaceholderText="Select a configured profile"
                                          IsEnabled="{Binding HasSelectedRule}" />
                                <Button Content="Clear"
                                        Command="{Binding ClearUseProfileCommand}"
                                        IsEnabled="{Binding HasSelectedRule}" />
                            </StackPanel>
                        </StackPanel>

                        <Button Content="Open rule editor"
                                HorizontalAlignment="Left"
                                Command="{Binding EditRuleCommand}"
                                IsEnabled="{Binding HasSelectedRule}" />

                        <Separator />

                        <StackPanel Spacing="8">
                            <TextBlock Text="Test URL"
                                       Style="{StaticResource SettingsSectionTitleStyle}" />
                            <TextBox Text="{Binding TestUrl, Mode=TwoWay}"
                                     Watermark="https://example.com" />
                            <Button Content="Test Rule"
                                    Command="{Binding TestRuleCommand}" />
                            <fa:InfoBar Title="Result"
                                        Severity="Informational"
                                        IsVisible="{Binding TestResult, Converter={StaticResource StringHasValueConverter}}"
                                        Message="{Binding TestResult}" />
                            <fa:InfoBar Title="Error"
                                        Severity="Error"
                                        IsVisible="{Binding TestError, Converter={StaticResource StringHasValueConverter}}"
                                        Message="{Binding TestError}" />
                        </StackPanel>
                    </StackPanel>
                </ScrollViewer>
            </Border>
        </Grid>
    </ScrollViewer>
</UserControl>
