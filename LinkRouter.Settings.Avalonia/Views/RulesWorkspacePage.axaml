<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:fa="using:FluentAvalonia.UI.Controls"
             xmlns:conv="clr-namespace:LinkRouter.Settings.Avalonia.Converters"
             xmlns:vm="clr-namespace:LinkRouter.Settings.ViewModels;assembly=LinkRouter.Settings.Core"
             x:Class="LinkRouter.Settings.Avalonia.Views.RulesWorkspacePage">
    <UserControl.Resources>
        <conv:StringHasValueConverter x:Key="StringHasValueConverter" />
    </UserControl.Resources>

    <ScrollViewer>
        <StackPanel Margin="{StaticResource PagePadding}" Spacing="24">
            <TextBlock Text="Rules" Style="{StaticResource PageTitleTextBlockStyle}" />

            <Grid ColumnDefinitions="2*,3*" ColumnSpacing="24">
                <Border Style="{StaticResource SettingsCardStyle}">
                    <Grid RowDefinitions="Auto,*" RowSpacing="16">
                        <fa:CommandBar DefaultLabelPosition="Right">
                            <fa:CommandBar.PrimaryCommands>
                                <fa:AppBarButton Label="Add"
                                                 Command="{Binding AddRuleCommand}">
                                    <fa:AppBarButton.IconSource>
                                        <fa:SymbolIconSource Symbol="Add" />
                                    </fa:AppBarButton.IconSource>
                                </fa:AppBarButton>
                                <fa:AppBarButton Label="Duplicate"
                                                 Command="{Binding DuplicateRuleCommand}"
                                                 CommandParameter="{Binding SelectedRule}">
                                    <fa:AppBarButton.IconSource>
                                        <fa:SymbolIconSource Symbol="Copy" />
                                    </fa:AppBarButton.IconSource>
                                </fa:AppBarButton>
                                <fa:AppBarButton Label="Delete"
                                                 Command="{Binding DeleteRuleCommand}"
                                                 CommandParameter="{Binding SelectedRule}">
                                    <fa:AppBarButton.IconSource>
                                        <fa:SymbolIconSource Symbol="Delete" />
                                    </fa:AppBarButton.IconSource>
                                </fa:AppBarButton>
                                <fa:AppBarButton Label="Move Up"
                                                 Command="{Binding MoveUpCommand}"
                                                 CommandParameter="{Binding SelectedRule}">
                                    <fa:AppBarButton.IconSource>
                                        <fa:SymbolIconSource Symbol="CaretUp" />
                                    </fa:AppBarButton.IconSource>
                                </fa:AppBarButton>
                                <fa:AppBarButton Label="Move Down"
                                                 Command="{Binding MoveDownCommand}"
                                                 CommandParameter="{Binding SelectedRule}">
                                    <fa:AppBarButton.IconSource>
                                        <fa:SymbolIconSource Symbol="CaretDown" />
                                    </fa:AppBarButton.IconSource>
                                </fa:AppBarButton>
                            </fa:CommandBar.PrimaryCommands>
                        </fa:CommandBar>

                        <ListBox Grid.Row="1"
                                 ItemsSource="{Binding Rules}"
                                 SelectedItem="{Binding SelectedRule, Mode=TwoWay}"
                                 MinHeight="360">
                            <ListBox.ItemTemplate>
                                <DataTemplate DataType="{x:Type vm:RuleEditorViewModel}">
                                    <StackPanel Spacing="4">
                                        <TextBlock Text="{Binding DisplayName}" FontWeight="SemiBold" />
                                        <TextBlock Text="{Binding Browser}" Foreground="{DynamicResource TextFillColorSecondaryBrush}" FontSize="12" />
                                    </StackPanel>
                                </DataTemplate>
                            </ListBox.ItemTemplate>
                        </ListBox>
                    </Grid>
                </Border>

                <Border Grid.Column="1" Style="{StaticResource SettingsCardStyle}">
                    <StackPanel Spacing="20">
                        <StackPanel Spacing="4">
                            <TextBlock Text="Selected rule" Style="{StaticResource SectionHeaderTextBlockStyle}" />
                            <TextBlock Text="{Binding SelectedRule.DisplayName, FallbackValue=Select a rule, TargetNullValue=Select a rule}" />
                        </StackPanel>

                        <ToggleSwitch Content="Enabled"
                                      IsChecked="{Binding SelectedRule.Enabled, Mode=TwoWay}"
                                      IsEnabled="{Binding HasSelectedRule}" />

                        <StackPanel Spacing="12">
                            <StackPanel Spacing="4">
                                <TextBlock Text="Match" />
                                <StackPanel Orientation="Horizontal" Spacing="12">
                                    <ComboBox ItemsSource="{Binding MatchTypes}"
                                              SelectedItem="{Binding SelectedRule.Match, Mode=TwoWay}"
                                              Width="160"
                                              IsEnabled="{Binding HasSelectedRule}" />
                                    <TextBox Text="{Binding SelectedRule.Pattern, Mode=TwoWay}"
                                             Width="240"
                                             Watermark="Pattern"
                                             IsEnabled="{Binding HasSelectedRule}" />
                                </StackPanel>
                            </StackPanel>

                            <StackPanel Spacing="4">
                                <TextBlock Text="Use profile" />
                                <StackPanel Orientation="Horizontal" Spacing="12">
                                    <ComboBox ItemsSource="{Binding ProfileOptions}"
                                              SelectedItem="{Binding SelectedRule.UseProfile, Mode=TwoWay}"
                                              Width="220"
                                              PlaceholderText="Select a configured profile"
                                              IsEnabled="{Binding HasSelectedRule}" />
                                    <Button Content="Clear"
                                            Command="{Binding ClearUseProfileCommand}"
                                            IsEnabled="{Binding HasSelectedRule}" />
                                </StackPanel>
                            </StackPanel>

                            <Button Content="Open full editor"
                                    Command="{Binding EditRuleCommand}"
                                    IsEnabled="{Binding HasSelectedRule}"
                                    HorizontalAlignment="Left" />
                        </StackPanel>

                        <Separator />

                        <StackPanel Spacing="8">
                            <TextBlock Text="Test URL" Style="{StaticResource SectionHeaderTextBlockStyle}" />
                            <TextBox Text="{Binding TestUrl, Mode=TwoWay}" Watermark="https://example.com" />
                            <StackPanel Orientation="Horizontal" Spacing="12">
                                <Button Content="Test rule" Command="{Binding TestRuleCommand}" />
                            </StackPanel>
                            <fa:InfoBar IsOpen="{Binding TestResult, Converter={StaticResource StringHasValueConverter}}"
                                        Severity="Success"
                                        Message="{Binding TestResult}" />
                            <fa:InfoBar IsOpen="{Binding TestError, Converter={StaticResource StringHasValueConverter}}"
                                        Severity="Error"
                                        Message="{Binding TestError}" />
                        </StackPanel>
                    </StackPanel>
                </Border>
            </Grid>
        </StackPanel>
    </ScrollViewer>
</UserControl>
