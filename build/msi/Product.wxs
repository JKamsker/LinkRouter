<?xml version="1.0" encoding="utf-8"?>
<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs"
     xmlns:util="http://wixtoolset.org/schemas/v4/wxs/util">
  <Package
      Name="LinkRouter"
      Language="1033"
      Version="$(var.ProductVersion)"
      Manufacturer="LinkRouter"
      UpgradeCode="{E1F27CE5-3F74-4A51-991C-3C4E1FE39FC9}"
      ProductCode="*"
      Scope="perUser"
      InstallerVersion="500"
      Compressed="yes">
    <MajorUpgrade DowngradeErrorMessage="A newer version of LinkRouter is already installed." />
    <MediaTemplate EmbedCab="yes" />
    <Icon Id="AppIcon" SourceFile="$(var.BinDir)\LinkRouter.Settings.exe" />
    <Property Id="ARPPRODUCTICON" Value="AppIcon" />
    <SummaryInformation Keywords="Installer" Description="LinkRouter desktop tools (settings UI and router launcher)." Manufacturer="LinkRouter" />
    <Feature Id="MainFeature" Title="LinkRouter" Level="1">
      <ComponentGroupRef Id="ProductComponents" />
      <ComponentRef Id="ProgramMenuShortcutComponent" />
    </Feature>
    <CustomAction Id="LaunchSettingsBackground"
                  Directory="INSTALLBIN"
                  Execute="immediate"
                  Impersonate="yes"
                  ExeCommand="cmd.exe /C start &quot;&quot; &quot;[INSTALLBIN]LinkRouter.Settings.exe&quot; --background"
                  Return="asyncNoWait" />
    <InstallExecuteSequence>
      <Custom Action="LaunchSettingsBackground" After="InstallFinalize" Condition="NOT REMOVE=&quot;ALL&quot;" />
    </InstallExecuteSequence>
    <util:CloseApplication Id="CloseExistingSettings"
                           Target="[INSTALLBIN]LinkRouter.Settings.exe" />
  </Package>

  <Fragment>
    <StandardDirectory Id="AppDataFolder">
      <Directory Id="INSTALLFOLDER" Name="LinkRouter">
        <Directory Id="INSTALLCONFIG" Name=".config" />
        <Directory Id="INSTALLBIN" Name="bin" />
      </Directory>
    </StandardDirectory>
    <StandardDirectory Id="ProgramMenuFolder">
      <Directory Id="ProgramMenuDir" Name="LinkRouter" />
    </StandardDirectory>
  </Fragment>

  <Fragment>
    <DirectoryRef Id="ProgramMenuDir">
      <Component Id="ProgramMenuShortcutComponent" Guid="{84A7C79F-4C6D-4F64-A3D7-0B02ABE82352}">
        <Shortcut Id="StartMenuShortcut"
                  Name="LinkRouter Settings"
                  Description="Configure LinkRouter rules and profiles."
                  Target="[INSTALLBIN]LinkRouter.Settings.exe"
                  WorkingDirectory="INSTALLBIN"
                  Icon="AppIcon" />
        <RemoveFolder Id="RemoveProgramMenuDir" On="uninstall" />
        <RegistryValue Root="HKCU" Key="Software\LinkRouter" Name="Installed" Type="integer" Value="1" KeyPath="yes" />
        <RegistryValue Root="HKCU"
                       Key="Software\Microsoft\Windows\CurrentVersion\Run"
                       Name="LinkRouter"
                       Type="string"
                       Value="&quot;[INSTALLBIN]LinkRouter.Settings.exe&quot; --minimized" />
      </Component>
    </DirectoryRef>
  </Fragment>
</Wix>
